name: Build application

on:
  pull_request:
    branches: [ main ]

  workflow_dispatch:

  workflow_call:
    inputs:
      store_artifacts:
        type: boolean
        required: false
        default: false
      prod_release:
        type: boolean
        required: false
      tag_name:
        type: string
        required: false

env:
  PROD_RELEASE: ${{ inputs.prod_release || 'false' }}
  TAG_NAME: ${{ inputs.tag_name || 'dev' }}

jobs:
  version:
    name: Versioning
    runs-on: ubuntu-latest

    steps:
      - name: Determine build version
        id: build_version
        run: |
          LEGACY_PIPELINE_BUILD_NO_START=267

          BUILD_NO=$((${{ github.run_number }} + $LEGACY_PIPELINE_BUILD_NO_START))
          echo "build_no=$BUILD_NO" >> $GITHUB_OUTPUT

      - name: Print versioning
        run: |
          echo "Version: $VERSION"
          echo "Run No: $BUILD_NO"
        env:
          VERSION: ${{ env.TAG_NAME }}
          BUILD_NO: ${{ steps.build_version.outputs.build_no }}

    outputs:
      version: ${{ env.TAG_NAME }}
      build_version: ${{ steps.build_version.outputs.build_no }}

  build_android:
    name: Build Android App
    runs-on: ubuntu-latest
    needs: [version]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.0

      - name: Build Android app
        uses: ./.github/actions/build_android
        with:
          version: ${{ needs.version.outputs.version }}
          build_version: ${{ needs.version.outputs.build_version }}
          store_artifacts: ${{ inputs.store_artifacts }}
          prod_release: ${{ env.PROD_RELEASE }}
