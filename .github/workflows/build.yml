name: Build application

on:
  pull_request:
    branches: [ main ]

  workflow_dispatch:

  workflow_call:
    inputs:
      store_artifacts:
        type: boolean
        required: false
        default: false
      prod_release:
        type: boolean
        required: false
      tag_name:
        type: string
        required: false

env:
  PROD_RELEASE: ${{ inputs.prod_release || 'false' }}
  TAG_NAME: ${{ inputs.tag_name || 'dev' }}

jobs:
  version:
    name: Versioning
    runs-on: ubuntu-latest

    steps:
      - name: Determine build version
        id: build_version
        run: |
          BUILD_NO=$((${{ github.run_number }} + 100))
          echo "::set-output name=build_no::$BUILD_NO"

      - name: Print versioning
        run: |
          echo "Version: $VERSION"
          echo "Run No: $BUILD_NO"
        env:
          VERSION: ${{ env.TAG_NAME }}
          BUILD_NO: ${{ steps.build_version.outputs.build_no }}

    outputs:
      version: ${{ env.TAG_NAME }}
      build_version: ${{ steps.build_version.outputs.build_no }}

  build_ios:
    name: Build iOS App
    runs-on: macos-latest
    needs: [version]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build iOS app
        uses: ./.github/actions/build_ios
        with:
          version: ${{ needs.version.outputs.version }}
          build_version: ${{ needs.version.outputs.build_version }}
          apple_ios_signing_cert_dev: ${{ secrets.APPLE_IOS_SIGNING_CERTIFICATE_DEVELOPMENT }}
          apple_ios_signing_cert_pw_dev: ${{ secrets.APPLE_IOS_SIGNING_CERTIFICATE_DEVELOPMENT_PASSWORD }}
          apple_ios_provisioning_profile_dev: ${{ secrets.APPLE_IOS_PROVISIONING_PROFILE_DEVELOPMENT }}
          apple_ios_signing_cert_prod: ${{ secrets.APPLE_IOS_SIGNING_CERT_PROD }}
          apple_ios_signing_cert_pw_prod: ${{ secrets.APPLE_IOS_SIGNING_CERT_PW }}
          apple_ios_provisioning_profile_prod: ${{ secrets.APPLE_IOS_PROVISIONING_PROFILE_PROD }}
          apple_keychain_pw: ${{ secrets.APPLE_KEYCHAIN_PW }}
          store_artifacts: ${{ inputs.store_artifacts }}
          prod_release: ${{ env.PROD_RELEASE }}

  build_android:
    name: Build Android App
    runs-on: ubuntu-latest
    needs: [version]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Android app
        uses: ./.github/actions/build_android
        with:
          version: ${{ needs.version.outputs.version }}
          build_version: ${{ needs.version.outputs.build_version }}
          store_artifacts: ${{ inputs.store_artifacts }}
          prod_release: ${{ env.PROD_RELEASE }}